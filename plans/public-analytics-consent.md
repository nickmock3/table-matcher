# 公開ユーザー計測（同意管理付き）実装計画

## 1. 対象仕様
- 仕様書: `docs/specs/features/public-analytics-consent.md`
- 対象範囲: 同意管理の最小導入 + 公開閲覧イベント収集の土台構築

## 2. 実装方針
- 同意管理は「解析用途のみ」の最小実装とし、公開画面共通で利用できるコンポーネント化を行う。
- 閲覧イベントAPIは薄い入力検証 + DB保存に限定し、集計/分配ロジックは後続タスクへ分離する。
- 同意状態に依存したイベント送信制御をクライアント側で実装し、未同意時は送信しない。
- 送信失敗は非ブロッキングとし、ユーザー表示を優先する。

## 3. 成果物
- 同意バナーUIおよび同意状態保存ロジック
- 閲覧イベント受信API
- `analytics_consents` / `page_view_events` 用スキーマ・マイグレーション
- 主要判定ロジックのunitテスト
- 実行結果を記録した `tasks/` 更新

## 4. 実装ステップ
1. 同意状態モデルとDBスキーマ（テーブル/型）を追加。
2. 公開画面で同意バナーを表示し、同意状態更新APIと接続。
3. 公開トップ/店舗詳細で閲覧イベント送信フックを導入。
4. 閲覧イベント保存APIを実装（payload検証、保存、エラー処理）。
5. unitテストを追加（同意判定、入力検証、重複判定キー）。
6. 必要e2eを追加（許可時送信、拒否時未送信）。
7. lint + unit + 必要e2e + build を実行してDoD確認。

## 5. テスト計画
- lint: `bun run lint`
- unit: `Vitest`（同意判定・入力検証・イベント整形）
- e2e: `Playwright`（公開導線で同意状態に応じた送信可否）
- build: `bun run build`

## 6. リスクと対策
- リスク: 同意UIの導入で公開画面初期描画が不安定になる。
- 対策: UIは最小状態管理にし、表示の有無判定をユニットで固定化する。

- リスク: イベント送信失敗がUXを阻害する。
- 対策: `navigator.sendBeacon` 優先、失敗時は `fetch` フォールバック、いずれも非同期で握りつぶし可能にする。

- リスク: 分配で使うにはデータ粒度が不足する。
- 対策: 先に必要最小項目を固定し、後続タスクで拡張可能な列設計にする。

## 7. 完了条件（DoD）
- `docs/specs/features/public-analytics-consent.md` の受け入れ条件を満たす。
- `spec + plan + tasks` の整合が取れている。
- `bun run lint` と関連unit、必要e2e、buildが通過している。
- AIレビューでブロッカー指摘がない、または対応方針が記録されている。

## 8. 変更履歴
- 2026-02-27: 初版作成
