# 店舗ユーザー向け画像管理 実装計画

## 1. 対象仕様
- 仕様書: `docs/specs/features/store-user-image-management.md`
- 対象範囲: 店舗ユーザーが自店舗画像を管理する画面/APIと公開画面反映

## 2. 実装方針
- 機能は `src/features/store-user-image-management/` に集約する。
- APIは `src/app/api/shop/images/route.ts`（取得/更新）と `src/app/api/shop/images/upload/route.ts`（アップロード）を用意し、店舗ユーザー認可を必須にする。
- `stores.image_urls` は既存方針どおりJSON文字列として保存し、入出力境界で配列へ変換する。
- 並び替えUIはドラッグ&ドロップ方式を採用する。
- アップロードはMVPで「API経由でR2へPUT」方式とし、MIME/サイズ制限をサーバー側で検証する。
- 画像削除時はDB更新と同時に対応するR2オブジェクトを即時削除する。

## 3. 成果物
- 店舗ユーザー向け画像管理画面（一覧、追加、削除、並び替え、保存）
- 店舗ユーザー向け画像更新API
- 店舗ユーザー向け画像アップロードAPI（R2保存）
- 画像配列バリデーションスキーマ
- unit/e2eテスト

## 4. 実装ステップ
1. 画像配列スキーマ（1〜10件、URL、重複禁止）と変換ユーティリティを実装。
2. 店舗ユーザー認可つき画像アップロードAPIを実装（MIME/サイズ/キー生成）。
3. 店舗ユーザー認可つき画像取得/更新APIを実装。
4. `/shop/images` 画面を実装（アップロード、削除、ドラッグ&ドロップ並び替え、保存）。
5. 保存成功後の通知とエラー表示を実装。
6. 店舗詳細画面への反映確認テストを追加。
7. `lint + unit + e2e + build` を実行しDoD確認。

## 5. テスト計画
- lint: `bun run lint`
- unit: `bun run test`（画像入力スキーマ、認可、アップロード制約、APIハンドラ中心）
- e2e: `bun run e2e`（店舗ユーザー画像アップロード導線 + 公開反映）
- build: `bun run build`

## 6. リスクと対策
- リスク: 店舗ユーザーと店舗の紐づけ解決が不明確で、誤店舗更新の可能性がある。
- 対策: API境界で「ログインユーザー -> 店舗ID」解決を単一関数化し、他店舗IDの入力を受け付けない。

- リスク: 画像配列のJSON文字列変換ミスで表示崩れが発生する。
- 対策: 変換ユーティリティを共通化し、unitテストで空・不正ケースを固定化する。

- リスク: E2Eで画像URLの外部依存により不安定化する。
- 対策: E2Eはアップロード成功レスポンスとURL反映を判定対象とし、外部CDN表示可否は判定対象外にする。

- リスク: 削除処理の途中失敗でDBとR2の整合が崩れる。
- 対策: 失敗時のロールバック/リトライ方針をAPIで明示し、単体テストで失敗系を固定化する。

## 7. 完了条件（DoD）
- 仕様書の受け入れ条件 1-6 を満たす。
- `spec + plan + tasks` の整合が取れている。
- `bun run lint` / `bun run test` / 必要e2e / `bun run build` が通過する。
- AIレビューの主要指摘に対応済み。

## 8. 変更履歴
- 2026-02-25: 初版作成
