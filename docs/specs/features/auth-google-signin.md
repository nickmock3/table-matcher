# Google認証（ログイン）機能 仕様書

## 概要
- 店舗ユーザー/管理者向けのGoogle認証ログインを提供する。
- Better Authを使ってセッションを発行し、保護APIから参照できる状態を作る。

## 背景・目的
- 店舗ユーザー空席更新や管理者機能の前提として認証が必要。
- 先に認証基盤を確定し、以降の権限機能を段階的に実装できるようにする。

## スコープ
### In scope
- Google OAuthログイン導線（ログイン/ログアウト）
- Better Authルート（`/api/auth/[...all]`）の運用確立
- セッション取得API（または確認手段）と画面反映
- 認証失敗時の最小エラーハンドリング

### Out of scope
- 役割ベースの画面分岐（管理者/店舗ユーザーの本格制御）
- 店舗メール紐づけ判定ロジック（次機能で対応）
- UIのデザイン最適化

## ユーザーストーリー
- 公開ユーザー: ログインなしで公開画面を閲覧したい。
- 店舗ユーザー: Googleアカウントでログインして店舗機能を使いたい。
- 管理者: Googleログインで管理機能へ進める前提を整えたい。

## 画面・導線
- 対象画面:
  - `src/app/` 配下のログイン導線ページ（新規）
  - 既存画面のヘッダー/導線（必要最小限）
- 遷移:
  - ログイン導線 -> Google認証 -> コールバック -> ログイン後画面
- 入口/出口:
  - 入口: ログインボタン
  - 出口: ログアウト操作

## 機能要件
1. 店舗ユーザー/管理者向けにGoogle認証を開始できるログイン導線があること。
2. 認証成功時にセッションが発行され、ログイン状態を取得できること。
3. ログアウト時にセッションが破棄されること。
4. 認証未設定/失敗時にユーザーへ再試行可能なエラーメッセージを表示すること。
5. `dev / demo / prod / local` のリダイレクトURI運用手順がドキュメント化されていること。
6. 公開ユーザー向け導線（トップ/店舗詳細）はログイン不要で利用できること。

## 非機能要件
- 可用性: 認証設定不足時も500ではなく明示的な失敗応答を返す。
- 運用上の制約: Google OAuth設定は環境ごとにURI完全一致で管理する。

## データ要件
- 主なエンティティ:
  - `user`
  - `session`
  - `account`
- 保存項目:
  - Better Auth標準スキーマに従う
- バリデーション制約:
  - サーバー環境変数が不足している場合は起動時/実行時に検知できること

## 権限・認可
- 誰が何をできるか:
  - 未認証ユーザー: ログインのみ可能
  - 認証済みユーザー: セッション参照・ログアウト可能
- 禁止操作:
  - 未認証ユーザーの保護APIアクセス（次機能で適用範囲を拡張）

## エラー/例外ケース
- 認証設定不足: 503 or 明示エラー応答
- 認証キャンセル: ログイン画面へ戻し再試行可能
- コールバック不整合: エラーメッセージ表示

## 受け入れ条件（Acceptance Criteria）
1. 店舗ユーザー/管理者がGoogleログインを開始し、成功後にログイン状態を確認できる。
2. ログアウト操作で未ログイン状態へ戻る。
3. 認証未設定時に開発者が原因を特定できるエラーメッセージが得られる。
4. 公開ユーザー向け導線はログインなしで利用できる。
5. `lint + unit + 必要e2e + build` が通過する。

## テスト観点
### Unit
- 環境変数解決（baseURL/redirectURI）の分岐
- 認証未設定時レスポンスのハンドリング

### E2E（必要時のみ）
- 対象導線: ログイン導線表示、ログイン状態表示、ログアウト導線
- 実施条件: Google本番連携は手動確認、E2Eはモックまたはテスト用フラグで実施

## 依存・前提
- 他機能依存:
  - 既存 `better-auth` 導入済みコード
- 外部サービス依存:
  - Google Cloud OAuthクライアント設定
- 先行タスク:
  - なし

## 未決定事項
- ログイン導線配置場所（トップ常設 or 専用ページ）
- ログイン後デフォルト遷移先

## 変更履歴
- 2026-02-18: 初版作成
