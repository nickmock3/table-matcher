# 公開画面への空席反映機能 仕様書

## 概要
- 店舗ユーザーが更新した空席情報を、公開向けトップ画面と店舗詳細画面に反映する。
- 反映対象は `seat_status_updates` の最新有効レコード（`expiresAt > now`）とする。

## 背景・目的
- 店舗ユーザー更新機能（`store-user-vacancy-update`）は成立しているが、公開画面への反映が未接続。
- 公開ユーザーの来店判断に必要な「今の空席状態」を一覧/詳細で一致して提示する。

## スコープ
### In scope
- 公開トップ画面（`/`）の空席状態反映
- 公開店舗詳細画面（`/stores/[storeId]`）の空席状態反映
- 有効期限切れ時の表示ルール（`unknown` 相当の扱い）
- 反映ロジック（最新有効レコード解決）の共通化

### Out of scope
- 店舗ユーザー更新UI/APIの仕様変更
- 通知機能（空席になったら通知）
- キャッシュ戦略の高度最適化（CDN再検証の細かな運用）

## ユーザーストーリー
- 公開ユーザー: トップ画面と店舗詳細画面で同じ空席状態を見て、迷わず来店判断したい。
- 店舗ユーザー: 更新した空席情報が公開画面にすぐ反映されることを確認したい。
- 管理者: 更新履歴から導出された表示ルールが一貫していることを担保したい。

## 画面・導線
- 対象画面:
  - `src/app/page.tsx`
  - `src/app/stores/[storeId]/page.tsx`
- 導線:
  - 公開ユーザーがトップ画面を閲覧
  - 店舗カードの空席状態を確認
  - 店舗詳細へ遷移して同状態を確認

## 機能要件
1. 公開画面は各店舗について `seat_status_updates` の最新有効レコードを参照して空席状態を決定すること。
2. 最新有効レコードが存在しない場合は `unavailable` として扱うこと（MVP方針）。
3. 最新レコードの解決順は `createdAt DESC, id DESC` とすること。
4. トップ画面と店舗詳細画面で同一ロジックを使用し、状態不整合が起きないこと。
5. トップ画面の「空席のみ」フィルタは反映後の状態で動作すること。
6. 店舗ユーザーが `available` 更新後、公開画面再取得時に `available` 表示となること。
7. 有効期限切れ後は公開画面再取得時に `unavailable` 扱いへ戻ること。

## 非機能要件
- 性能: 一覧表示での空席状態解決が体感を悪化させないこと。
- 一貫性: トップ/詳細で同一店の状態が一致すること。
- 運用: 反映ロジックの変更時は unit テストで回帰検知できること。

## データ要件
- 主なエンティティ:
  - `stores`
  - `seat_status_updates`
- 参照条件:
  - `storeId` ごとに `expiresAt > now` を満たすレコード
  - 並び順 `createdAt DESC, id DESC`
- 導出値:
  - 公開表示用 `vacancyStatus: available | unavailable`

## 権限・認可
- 公開ユーザー: 閲覧のみ
- 店舗ユーザー: 本仕様では更新操作を含まない（別仕様で定義済み）

## エラー/例外ケース
- DB参照失敗時: 公開画面は安全側で `unavailable` を返し、致命エラーを回避する。
- 該当店舗なし時: 既存仕様どおり404（詳細画面）。

## 受け入れ条件（Acceptance Criteria）
1. トップ画面で各店舗の空席状態が更新履歴に基づいて表示される。
2. 店舗詳細画面でトップ画面と同じ空席状態が表示される。
3. 空席あり更新後、公開画面再取得で `available` が確認できる。
4. `expiresAt` 経過後、公開画面再取得で `unavailable` 扱いになる。
5. 「空席のみ」フィルタが反映後状態で正しく絞り込まれる。

## テスト観点
### Unit
- 最新有効レコード選択（`createdAt DESC, id DESC`）
- 期限切れ除外（`expiresAt <= now`）
- 表示状態導出（`available/unavailable`）

### E2E（必要時のみ）
- 対象導線: 空席更新（モック） -> トップ表示確認 -> 詳細表示確認
- 実施条件: 主要導線として実施

## 依存・前提
- 他機能依存:
  - `store-user-vacancy-update`（更新データの生成）
  - 既存トップ画面/詳細画面
- 先行タスク:
  - なし（本機能が次実装対象）

## 未決定事項
- なし

## 変更履歴
- 2026-02-17: 初版作成
