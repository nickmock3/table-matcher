# 公開ユーザー計測（同意管理付き）機能仕様書

## 概要
- 公開ユーザーのページ閲覧ログを、同意状態に応じて収集する。
- 店舗ユーザー/管理者への広告分配計算に利用できる基礎データを作る。

## 背景・目的
- 広告収益を店舗側へ分配するため、公開画面の閲覧実績を蓄積する必要がある。
- 法令/ガイドライン観点で、解析用途のCookie等は同意状態を明示管理したい。

## スコープ
### In scope
- 解析同意バナー（許可/拒否）表示と同意状態保存
- 同意状態に応じた閲覧イベント送信制御
- 閲覧イベント受信API（最小バリデーション）
- 日次集計のための最低限データ保存（生イベント）

### Out of scope
- 本番向けの厳密な法務文言確定
- 広告費実額の請求/支払処理
- 高度な不正検知（ボット判定の高度化、指紋生成）

## ユーザーストーリー
- 公開ユーザー: 解析同意の可否を選択し、後から変更できる。
- 店舗ユーザー: 自店舗の閲覧実績を分配根拠として確認できる（後続タスク）。
- 管理者: 分配計算に使える閲覧ログを取得・集計できる。

## 画面・導線
- 対象画面:
  - 公開画面共通（同意バナー）
  - 公開トップ/店舗詳細（閲覧イベント対象）
- 遷移:
  - 初回表示 -> 同意バナー表示 -> 許可/拒否選択
  - 設定変更導線（フッター等）から再設定
- 入口/出口:
  - 入口: 公開ページアクセス時
  - 出口: 同意状態保存完了、または閲覧イベント送信完了

## 機能要件
1. 同意未確定時に同意バナーを表示し、`accepted` / `rejected` を保存できる。
2. 同意が `accepted` の場合のみ、閲覧イベント送信を行う。
3. 同意が `rejected` または未確定の場合、解析イベントを送信しない。
4. 閲覧イベントは少なくとも `storeId(任意)`, `path`, `occurredAt`, `anonId`, `sessionId` を保存する。
5. 同一 `anonId + storeId + path + 30分` は重複として扱えるよう、判定に必要な情報を保存する。
6. 同意状態はユーザーが後から再設定できる。

## 非機能要件
- 性能: 閲覧イベント送信はUXを阻害しない（非同期、失敗時は画面表示をブロックしない）。
- 可用性: 計測API失敗時も公開画面は正常表示される。
- 運用上の制約: 収益分配の正本はアプリDB上の集計データとする。

## データ要件
- 主なエンティティ:
  - `analytics_consents`
  - `page_view_events`
- 保存項目:
  - `analytics_consents`: `anon_id`, `status`, `updated_at`
  - `page_view_events`: `id`, `store_id`, `path`, `anon_id`, `session_id`, `occurred_at`, `created_at`
- バリデーション制約:
  - `status` は `accepted|rejected`
  - `path` は先頭 `/` 必須
  - `store_id` は店舗詳細閲覧時のみ必須

## 権限・認可
- 公開ユーザー: 同意状態の作成/更新、公開イベント送信
- 店舗ユーザー: 本仕様範囲では閲覧のみ（集計参照は後続）
- 管理者: 本仕様範囲では運用/確認のみ（管理UIは後続）

## エラー/例外ケース
- 入力エラー: 不正なイベントpayloadは `400` を返す。
- 権限エラー: 公開APIのため認証は不要、ただし不正入力は拒否する。
- 外部API失敗: なし（内部保存失敗時は `500` を返すが画面表示は継続）。

## 受け入れ条件（Acceptance Criteria）
1. 初回アクセス時、同意バナーが表示されて許可/拒否を保存できる。
2. `accepted` 時のみ閲覧イベントが保存される。
3. `rejected` 時は閲覧イベントが保存されない。
4. 同意状態を変更すると次回イベント送信挙動に反映される。
5. 分配計算の前段として必要なイベント項目がDBに保存される。

## テスト観点
### Unit
- 同意状態判定ロジック
- 閲覧イベントpayloadバリデーション
- 重複判定キー生成ロジック

### E2E（必要時のみ）
- 対象導線:
  - 公開ページ表示 -> 同意許可 -> イベント送信
  - 公開ページ表示 -> 同意拒否 -> イベント未送信
- 実施条件:
  - ローカルD1で検証可能なこと

## 依存・前提
- 他機能依存:
  - 店舗詳細ページ（`/stores/[storeId]`）
- 外部サービス依存:
  - なし（初期は自前保存）
- 先行タスク:
  - なし

## 未決定事項
- 同意文言の最終版（法務レビュー）
- 分配計算の確定ロジック（手数料率、丸め規則、最低保証）
- ボット除外ルールの具体値
- 閲覧ログ `path` の許可範囲（現状は先頭 `/` のみ検証、将来的に公開画面パスへ制限予定）

## 変更履歴
- 2026-02-27: 初版作成
- 2026-02-27: `path` 許可範囲の段階導入方針を未決定事項へ追記
