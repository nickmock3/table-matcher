# 店舗ユーザー向け画像管理 仕様書

## 概要
- 店舗ユーザーが自店舗の宣材画像を管理（追加・並び替え・削除）できる機能を提供する。
- 公開画面（店舗詳細）に表示される `imageUrls` を店舗運用で更新可能にする。

## 背景・目的
- 現在は店舗画像が固定データに依存しており、店舗側で更新できない。
- 管理者の店舗基本情報管理とは責務を分離し、画像運用は店舗ユーザーが自己完結できる状態にする。

## スコープ
### In scope
- 店舗ユーザー向け画像管理画面（自店舗のみ）
- 画像追加（R2アップロード）
- 画像削除
- 画像並び順変更
- 画像枚数制約（1〜10枚）
- 更新結果の店舗詳細画面への反映

### Out of scope
- 画像自動圧縮・トリミング
- 複数店舗管理者の一括編集

## ユーザーストーリー
- 公開ユーザー: 最新の店舗画像を店舗詳細で確認したい。
- 店舗ユーザー: 自店舗の魅力が伝わる画像を差し替え・整理したい。
- 管理者: 店舗の基本情報管理とは分離して、日常運用は店舗ユーザーに委譲したい。

## 画面・導線
- 対象画面:
  - `src/app/shop/images/page.tsx`（新規）
  - `src/app/stores/[storeId]/page.tsx`（反映先）
- 遷移:
  - 店舗ユーザーメニュー -> 画像管理画面
  - 画像更新 -> 保存 -> 成功表示
  - 公開画面で反映確認
- 入口/出口:
  - 入口: `/shop/images`
  - 出口: `/shop`（または店舗ユーザー用メニュー）

## 機能要件
1. ログイン済み店舗ユーザーのみ画像管理画面/APIへアクセスできること。
2. 対象店舗はログインユーザーに紐づく1店舗に限定されること。
3. 画像URLを1〜10件で保存できること。
4. 0件保存は不可（最低1件）とし、バリデーションエラーを表示すること。
5. 画像の並び順を変更して保存できること。
6. 保存後の `imageUrls` が店舗詳細画面に反映されること。
7. 不正なURL形式・重複URLはバリデーションで拒否すること。
8. 画像追加時に画像ファイル（`image/*`）をR2へアップロードできること。
9. アップロード可能サイズ上限を設け、超過時は4xxで拒否すること。
10. 画像の並び替えUIはドラッグ&ドロップ方式で提供すること。
11. 画像削除時は対応するR2オブジェクトも即時削除すること。

## 非機能要件
- 一貫性: 保存成功後、同一店舗の公開詳細で順序含め同じ画像配列が表示されること。
- 可用性: 入力エラーは4xxで返し、画面で原因が分かること。
- 保守性: 画像URL配列の変換・検証を共通化し、管理者側実装と重複を最小化すること。
- セキュリティ: 他店舗のオブジェクトキーを指定した上書きを防止すること。
- 運用: R2削除失敗時は同期リクエスト内で整合性を崩さず保存を完了し、削除再試行はジョブキューで非同期処理すること。

## データ要件
- 主なエンティティ:
  - `stores.image_urls`
  - `users`（`role=shop` 判定）
- 保存項目:
  - `stores.id`
  - `stores.image_urls`（JSON配列文字列）
  - `R2 object key`（例: `stores/{storeId}/{uuid}.{ext}`）
- バリデーション制約:
  - 件数: 1〜10
  - URL: `https://`（公開配信用URL）
  - 重複: 不可
  - MIME: `image/*` のみ
  - サイズ: 上限以内（値は実装時に定数化）

## 権限・認可
- 店舗ユーザー:
  - 自店舗の画像のみ更新可能
- 管理者:
  - 本仕様の画面/APIは対象外（別管理機能）
- 禁止操作:
  - 未ログイン、公開ユーザー、他店舗ユーザーによる更新

## エラー/例外ケース
- 未ログイン: 401
- 非店舗ユーザー: 403
- 店舗紐づけなし: 404
- 入力不正（件数超過/URL不正/重複）: 400
- アップロード不正（MIME不一致/サイズ超過）: 400
- 内部エラー: 500

## 受け入れ条件（Acceptance Criteria）
1. 店舗ユーザーが `/shop/images` で現在画像一覧を確認できる。
2. 画像追加/削除/並び替え後に保存できる。
3. 1〜10枚制約とURL検証が動作する。
4. 他ロール・未ログインは更新できない（401/403）。
5. 保存結果が店舗詳細画面に反映される。
6. 画像ファイルがR2へアップロードされ、保存後に表示される。
7. `lint + unit + 必要e2e + build` が通過する。

## テスト観点
### Unit
- 画像配列バリデーション（件数、URL、重複）
- 店舗ユーザー認可判定
- 保存データ整形（配列 <-> JSON文字列）
- アップロード制約（MIME、サイズ上限、オブジェクトキー生成）

### E2E（必要時のみ）
- 店舗ユーザーログイン -> 画像アップロード/編集 -> 保存 -> 店舗詳細反映
- 未ログイン/他ロールでの拒否確認

## 依存・前提
- 他機能依存:
  - `docs/specs/features/auth-google-signin.md`
  - `docs/specs/features/authz-protected-api.md`
  - `docs/specs/features/store-data-source-of-truth.md`
- 外部サービス依存:
  - Cloudflare R2（`BUCKET_IMAGES`）
- 先行タスク:
  - 店舗ユーザー向け認可導線の整備完了

## 未決定事項
- 画像制限の最終値（推奨初期値）
  - 1ファイル上限: 5MB
  - 許可MIME: `image/jpeg`, `image/png`, `image/webp`
  - 寸法上限: 長辺4096px
  - 配信用の目安: サムネイル640px、メイン1280px

## 変更履歴
- 2026-02-25: 初版作成
- 2026-02-25: 画像追加方式をURL入力からR2アップロードへ変更
- 2026-02-25: 画像サイズ制限の推奨初期値を未決定事項に追記
- 2026-02-25: 並び替えUIをドラッグ&ドロップに確定、削除ポリシーをR2即時削除に確定
- 2026-02-25: R2削除失敗時の再試行方式としてジョブキュー方針を追記
