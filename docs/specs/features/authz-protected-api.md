# 保護API（認証/認可ガード）仕様書

## 概要
- ログインセッションがある場合のみ通過できる保護APIの共通仕様を定義する。
- 店舗ユーザー/管理者の権限判定と、店舗スコープ判定を共通ガードとして提供する。

## 背景・目的
- APIごとに認証/認可ロジックが分散すると、判定漏れやレスポンス不整合が発生しやすい。
- 共通ガードを先に定義し、以降の機能APIで安全に再利用できる状態を作る。

## スコープ
### In scope
- セッション必須ガード（401）
- 役割ガード（403）
- 店舗スコープガード（403）
- エラーレスポンス形式の共通化

### Out of scope
- トークンベース認証（Bearer等）
- ABACなど高度なポリシーエンジン
- 管理者UI側の詳細権限管理

## ユーザーストーリー
- 公開ユーザー: 保護APIは未ログインで実行できないことが保証されていてほしい。
- 店舗ユーザー: 自店舗に関する操作だけ実行できてほしい。
- 管理者: 管理者権限が必要なAPIのみ実行できることが明確であってほしい。

## 画面・導線
- 対象:
  - `src/app/api/**` の保護対象ルート
  - `src/features/authz/**`（新規想定）
- 導線:
  - API呼び出し -> 認証判定 -> 認可判定 -> 業務ロジック

## 機能要件
1. 未ログイン時は保護APIで `401 Unauthorized` を返す。
2. ログイン済みでも必要ロールを満たさない場合は `403 Forbidden` を返す。
3. 店舗ユーザーは `store_user_links` で紐づく店舗IDのみ操作可能とする。
4. 認証/認可エラー時のレスポンス形式（`ok`, `message`）を統一する。
5. 保護APIは共通ガード関数を使用し、各APIで判定実装を重複させない。

## 非機能要件
- 一貫性: 同種エラーは全APIで同じHTTPステータスと形式を返す。
- 保守性: 判定ロジックは共通モジュールへ集約する。

## データ要件
- 主なエンティティ:
  - `user` / `session`（Better Auth）
  - `users`（アプリ側ロール）
  - `store_user_links`
- 保存項目:
  - 本機能で新規保存はしない（参照のみ）
- バリデーション制約:
  - `role` は `users.role` を正として判定

## 権限・認可
- 店舗ユーザー:
  - 自店舗スコープのみ許可
- 管理者:
  - 管理者向けAPIのみ許可
- 禁止操作:
  - 未ログインユーザーの保護APIアクセス
  - 店舗ユーザーの他店舗操作

## エラー/例外ケース
- 未ログイン: 401
- ロール不足: 403
- 店舗紐づけ不一致: 403
- 内部エラー: 500

## 受け入れ条件（Acceptance Criteria）
1. 保護APIで未ログイン時に401が返る。
2. ロール不足時に403が返る。
3. 店舗スコープ不一致時に403が返る。
4. 既存APIへの適用で回帰がない（主要導線が維持される）。
5. `lint + unit + 必要e2e + build` が通過する。

## テスト観点
### Unit
- 認証ガード（401）
- ロールガード（403）
- 店舗スコープガード（403）

### E2E（必要時のみ）
- 保護APIを呼ぶ画面で、未認証/認可エラー表示を確認

## 依存・前提
- 他機能依存:
  - `docs/specs/features/auth-google-signin.md`
- 外部サービス依存:
  - なし
- 先行タスク:
  - Google認証導線の整備

## 未決定事項
- `users.role` の最終enum（`shop` / `admin` 以外を含むか）
- 403/404秘匿方針の統一

## 変更履歴
- 2026-02-18: 初版作成
