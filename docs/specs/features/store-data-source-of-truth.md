# 店舗情報のDB正本化 仕様書

## 概要
- 店舗情報（店名・住所・位置情報・画像）をDB（`stores`）を正本として扱う。
- 公開画面・店舗ユーザー画面に残るモック補完依存を解消し、参照元を統一する。

## 背景・目的
- 現在は `mockStoreRepository` に店舗情報が分散しており、DBデータとの乖離リスクがある。
- 正本をDBに一本化して、表示の一貫性と今後の運用（更新・拡張）を担保する。

## スコープ
### In scope
- `stores` スキーマ拡張（住所・緯度経度・画像URL配列）
- 既存データの移行（マイグレーション/シード整備）
- 公開画面（トップ/詳細）の店舗情報参照をDB正本化
- 店舗ユーザー空席更新画面の店舗表示情報参照をDB正本化
- 既存モック補完ロジックの撤去

### Out of scope
- 管理画面での店舗情報編集UI
- 画像アップロード機能
- 複数画像の高度な管理（並び替えUIなど）

## ユーザーストーリー
- 公開ユーザー: トップと詳細で一貫した店舗情報を見たい。
- 店舗ユーザー: 自店舗名や画像が管理された正しい情報で表示されてほしい。
- 管理者: 店舗情報の参照元がDBで一元化されていてほしい。

## 画面・導線
- 対象画面:
  - `src/app/page.tsx`
  - `src/app/stores/[storeId]/page.tsx`
  - `src/app/shop/seat-status/page.tsx`
- 導線:
  - トップで店舗一覧閲覧
  - 詳細画面遷移
  - 店舗ユーザー画面で店舗名/画像確認

## 機能要件
1. `stores` に `address`（nullable）, `latitude`（nullable）, `longitude`（nullable）, `imageUrls`（nullable）を保持できること。
2. 店舗表示に必要な情報はDBから取得し、モック依存なしで画面描画できること。
3. トップ画面と詳細画面で同一店舗情報（店名・画像・位置情報）を参照すること。
4. 店舗ユーザー空席更新画面の店舗名/画像はDB正本を参照すること。
5. 画像未設定時は既存フォールバックUI（準備中表示）で表示崩れしないこと。
6. 既存の空席反映ロジック（`seat_status_updates`）と共存し、表示状態が回帰しないこと。

## 非機能要件
- 可用性: 新旧データ移行中でも画面が致命エラーにならないこと。
- 一貫性: 店舗ID単位で画面間の表示が一致すること。
- 保守性: 取得ロジックを共通化し、重複実装を避けること。

## データ要件
- 対象テーブル: `stores`
- 追加/利用カラム:
  - `address`: text null
  - `latitude`: real/number null
  - `longitude`: real/number null
  - `image_urls`: text null（JSON文字列で配列管理）
- 互換要件:
  - 既存レコードで新カラム未設定でも画面描画可能であること

## 権限・認可
- 公開ユーザー: 閲覧のみ
- 店舗ユーザー: 閲覧と空席更新（店舗情報編集は対象外）

## エラー/例外ケース
- 新カラム欠損時: 既存フォールバック表示（画像準備中、地図フォールバック）
- JSON不正時: `image_urls` は空配列扱い
- DB参照失敗時: 既存の安全側表示（空席 `unavailable`、該当なし404）を維持

## 受け入れ条件（Acceptance Criteria）
1. トップ画面がDB由来の店舗情報で描画される。
2. 詳細画面がDB由来の店舗情報（画像/住所/位置）で描画される。
3. 店舗ユーザー画面がDB由来の店舗名/画像を表示する。
4. モック補完なしでも主要導線（トップ→詳細、店舗ユーザー画面）が成立する。
5. `lint + unit + e2e + build` が通過する。

## テスト観点
### Unit
- `stores` レコード -> 画面用モデル変換（`image_urls` パース含む）
- フォールバック判定（画像なし/位置情報なし）
- 既存空席反映ロジックとの結合点

### E2E（必要時のみ）
- トップ表示と詳細表示の店舗情報一致
- 店舗ユーザー画面の店舗名/画像表示

## 依存・前提
- 他機能依存:
  - `public-vacancy-reflection`
  - `store-user-vacancy-update`
- 先行タスク:
  - なし

## 未決定事項
- `image_urls` の永続化形式（JSON文字列運用で確定済みとするか、別テーブル分離するか）

## 変更履歴
- 2026-02-17: 初版作成
