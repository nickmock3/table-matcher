# 管理者向け店舗管理 仕様書

## 概要
- 管理者が店舗情報を登録・編集し、公開/非公開を切り替えられる機能を提供する。
- 公開画面で表示される店舗データの運用起点を管理者画面に統一する。

## 背景・目的
- 現在は店舗データの変更をDB直接操作やseedに依存しており、運用手順が分散している。
- 管理者機能として店舗情報管理を提供し、公開品質と更新速度を改善する。

## スコープ
### In scope
- 管理者向け店舗一覧画面
- 店舗新規登録
- 店舗編集（店名、住所、市区町村、ジャンル、予約URL、位置情報、画像URL配列）
- 店舗公開/非公開切り替え（`is_published`）
- 管理者ロール必須の認可ガード適用

### Out of scope
- 画像アップロード（R2保存UI）
- 住所から緯度経度の自動ジオコーディング
- ダッシュボード/収益管理
- 店舗ユーザー紐づけ編集

## ユーザーストーリー
- 公開ユーザー: 非公開店舗が一覧や詳細に表示されない状態で閲覧したい。
- 店舗ユーザー: 管理者が更新した店舗情報が公開画面に反映されていてほしい。
- 管理者: 画面操作で店舗情報の登録・編集・公開制御を安全に行いたい。

## 画面・導線
- 対象画面:
  - `src/app/admin/stores/page.tsx`（一覧）
  - `src/app/admin/stores/new/page.tsx`（新規）
  - `src/app/admin/stores/[storeId]/page.tsx`（編集）
- 遷移:
  - 管理者ログイン -> 店舗一覧 -> 新規/編集 -> 保存 -> 一覧へ戻る
- 入口/出口:
  - 入口: 管理者メニュー
  - 出口: 一覧戻り、ログアウト

## 機能要件
1. 管理者のみが店舗管理画面と店舗管理APIへアクセスできること。
2. 店舗新規登録時に必須項目（店名、市区町村、ジャンル、予約URL）を検証し、保存できること。
3. 店舗編集で既存項目を更新できること。
4. `is_published` の切り替え結果が公開画面の表示可否に反映されること。
5. 管理APIのエラー形式は `ok`, `message` を含む統一形式とすること。

## 非機能要件
- 一貫性: 管理画面更新後、公開データ取得結果が矛盾しないこと。
- 可用性: 入力不備時は4xxで明示エラーを返し、500を乱発しないこと。
- 保守性: 入力検証と認可判定を共通化し、重複を避けること。

## データ要件
- 主なエンティティ:
  - `stores`
  - `users`（`role=admin` 判定）
- 保存項目:
  - `stores.name`
  - `stores.address`
  - `stores.city`
  - `stores.genre`
  - `stores.latitude` / `stores.longitude`
  - `stores.image_urls`
  - `stores.reservation_url`
  - `stores.is_published`
- バリデーション制約:
  - `reservation_url` はURL形式
  - `image_urls` はJSON文字列配列
  - `latitude`/`longitude` は片方のみ不可（両方nullまたは両方数値）

## 権限・認可
- 管理者:
  - 店舗の作成/編集/公開切り替えが可能
- 店舗ユーザー:
  - 管理機能は利用不可
- 禁止操作:
  - 未ログイン・非管理者の管理APIアクセス

## エラー/例外ケース
- 未ログイン: 401
- 非管理者: 403
- 入力不正: 400
- 対象店舗なし: 404
- 内部エラー: 500

## 受け入れ条件（Acceptance Criteria）
1. 管理者で店舗新規登録が成功する。
2. 管理者で店舗編集が成功する。
3. 非管理者アクセス時に401/403が返る。
4. 公開/非公開切り替えが公開画面の表示に反映される。
5. `lint + unit + 必要e2e + build` が通過する。

## テスト観点
### Unit
- 入力バリデーション（必須項目、URL、緯度経度ペア）
- 管理者認可ガード
- `is_published` 反映ロジック

### E2E（必要時のみ）
- 管理者ログイン -> 店舗作成/編集導線
- 非管理者アクセス拒否
- 公開画面への表示反映確認

## 依存・前提
- 他機能依存:
  - `docs/specs/features/auth-google-signin.md`
  - `docs/specs/features/authz-protected-api.md`
  - `docs/specs/features/store-data-source-of-truth.md`
- 外部サービス依存:
  - なし（本仕様範囲では外部APIを直接利用しない）
- 先行タスク:
  - 認証導線・認可ガードの整備完了

## 未決定事項
- 管理者向けメニューの配置（ヘッダー常設/専用ダッシュボード）
- 管理者UIでのジャンル選択方式（固定選択肢/自由入力）

## 変更履歴
- 2026-02-24: 初版作成
