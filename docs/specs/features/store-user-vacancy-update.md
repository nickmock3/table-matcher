# 店舗ユーザー空席更新機能 仕様書

## 概要
- 店舗ユーザーが自店舗の空席状態を更新できる機能を提供する。
- 更新値は `available / unavailable` の2値とし、有効期限は更新時刻から30分固定とする。

## 背景・目的
- 空席情報の鮮度を保つため、店舗側が短時間で状態更新できる導線が必要。
- 公開一覧/詳細に反映される情報を、店舗ユーザー自身で更新できるようにする。

## スコープ
### In scope
- 店舗ユーザー向け更新画面（自店舗のみ）
- 空席更新API（認証/認可込み）
- 更新履歴保存（`seat_status_updates`）
- 公開画面への反映前提となる最新ステータス取得仕様

### Out of scope
- 管理者向けの代理更新UI
- 複数店舗の一括更新
- 更新スケジュール/自動更新

## ユーザーストーリー
- 公開ユーザー: 最新の空席状態を見て来店判断したい。
- 店舗ユーザー: 自店舗の空席状態をすぐ更新したい。
- 管理者: 店舗ユーザーの更新をデータとして参照したい（本機能では閲覧UI未対応）。

## 画面・導線
- 対象画面:
  - `src/app/shop/seat-status`（想定）
- 遷移:
  - 店舗ユーザーログイン
  - 空席更新画面表示
  - 状態更新操作
  - 成功/失敗メッセージ表示
- 入口/出口:
  - 入口: 店舗ユーザー専用導線
  - 出口: 同画面内で状態確認、必要に応じてトップ画面へ

## 機能要件
1. 認証済み店舗ユーザーのみ空席更新APIを実行できること。
2. 店舗ユーザーは `store_user_links` で紐づいた自店舗のみ更新できること。
3. 更新値は `available / unavailable` の2値のみ受け付けること。
4. 更新時に `seat_status_updates` へレコードを追加し、`expiresAt = updatedAt + 30分` で保存すること。
5. 更新成功時、画面上で現在状態と有効期限を表示すること。
6. 認可違反（他店舗更新）時は403を返すこと。
7. 未認証時は401を返すこと。

## 非機能要件
- 性能: 更新APIは通常操作で1秒以内の応答を目標とする。
- 可用性: 更新失敗時に再試行可能なUIを提供する。
- 運用上の制約: MVPでは監査ログは `seat_status_updates` の保存をもって代替する。

## データ要件
- 主なエンティティ:
  - `users`
  - `store_user_links`
  - `seat_status_updates`
- 保存項目:
  - `seat_status_updates.status`: `available | unavailable`
  - `seat_status_updates.expiresAt`: epoch seconds
  - `seat_status_updates.updatedByUserId`: 更新ユーザー
- バリデーション制約:
  - `status` は enum 2値のみ
  - `storeId` は認可済み店舗IDのみ許可

## 権限・認可
- 誰が何をできるか:
  - 店舗ユーザー: 自店舗の空席更新のみ
  - 管理者: 本機能では更新対象外
- 禁止操作:
  - 店舗ユーザーによる他店舗の更新

## エラー/例外ケース
- 入力エラー: 不正な `status` は400
- 権限エラー: 認可違反は403
- 認証エラー: セッションなしは401
- DB失敗: 500とし、ユーザーへ再試行案内を表示

## 受け入れ条件（Acceptance Criteria）
1. 店舗ユーザーが自店舗の空席状態を更新できる。
2. 更新結果が `seat_status_updates` に保存される。
3. `expiresAt` が更新時刻+30分で保存される。
4. 未認証/他店舗更新は拒否される（401/403）。
5. 更新後に画面で現在状態を確認できる。

## テスト観点
### Unit
- `status` バリデーション
- `expiresAt` 計算
- 認可判定（自店舗/他店舗）

### E2E（必要時のみ）
- 対象導線: ログイン -> 更新画面 -> 状態更新 -> 成功表示
- 実施条件: 主要導線として実施

## 依存・前提
- 他機能依存:
  - Better Auth セッション取得
  - 店舗ユーザーと店舗紐付けデータ
- 外部サービス依存: なし
- 先行タスク: 店舗ユーザー向け画面導線定義

## 未決定事項
- 店舗ユーザー画面のURL最終確定（`/shop/seat-status` を仮置き）
- 更新後の公開画面反映方式（SSR再取得/キャッシュ再検証）の詳細

## 変更履歴
- 2026-02-16: 初版作成
