# 開発方針（確定版）

このドキュメントは、プロジェクトの開発方針の正本です。  
「決定事項」と「未決定事項」を明確に分けて管理します。

## 1. 目的
- AIエージェントを活用しつつ、仕様の抜け漏れを減らして安全に開発を進める。
- 機能単位で仕様を固めてから実装する。

## 2. 現在の前提（決定済み）
- 開発は機能単位で進める。
- 機能仕様書は `docs/specs/features/` 配下に作成する。
- ルール策定フェーズ中は、具体機能の実装を行わない。

## 3. ドキュメント運用ルール
- このファイル（`docs/development-policy.md`）を開発方針の正本とする。
- 仕様の正本は `docs/specs/` 配下とする。
- 技術用語の正本は `docs/glossary.md` とする。
- パス表記はプロジェクトルート基準の相対パスで統一する。
- 未決定事項は「未決定」と明記し、決定時に日付付きで更新する。

## 4. 仕様策定フロー（決定）
1. 対象機能を決める。
2. `docs/specs/features/` に機能仕様書を追加する。
3. 仕様レビューで合意する（スコープ・受け入れ条件・例外系）。
4. 合意した機能ごとに `plans/` に実装計画を作成する。
5. 実装計画をもとに `tasks/` に実装用TODOを作成する。
6. 合意済みの仕様と計画に基づいて実装する。

## 4.1 機能ごとの成果物ルール（決定）
- `docs/specs/features/`: 機能仕様書
- `plans/`: 機能実装計画
- `tasks/`: 機能実装TODO
- 原則として、上記3点が揃ってから実装に着手する。

## 5. AIエージェント利用方針（決定）
- AIへの依頼は「目的」「対象ファイル」「制約」を明示する。
- 仕様未確定の機能は、実装依頼ではなく仕様相談として扱う。
- 変更時は、関連ドキュメントの更新有無もセットで確認する。

## 6. 未決定事項
- なし（2026-02-10時点）

## 6.1 テスト方針（決定）
- 単体テストを基本とする。
- 単体テストには `Vitest` を使用する。
- 単体テストファイルは実装コードの直近に配置する（同一ディレクトリ）。
  - 例: `foo.ts` に対して `foo.test.ts`
- E2Eテストには `Playwright` を使用する。
- E2Eは初期段階では主要導線のみを対象にする。
- E2E対象は必要に応じて段階的に追加する。
- 機能実装時は、`tasks/` にテスト作業（unit/e2eの要否）を明記する。

## 6.2 ディレクトリ/設計方針（決定）
- 基本方針は Vertical Slice Architecture とする。
- コードは機能ごと・画面ごとにまとめる。
- 初期実装は機能単位のトランザクションスクリプトを基本とする。
- 複雑な機能は、機能単位で DDD や CQRS を適用する。
- 設計スタイルの選択は機能ごとに行い、全機能へ一律適用しない。

### 6.2.1 具体運用
- 推奨配置: `src/features/<feature>/...`
- `src/app` はルーティング/画面エントリとして薄く保ち、主要ロジックは `src/features` 側に寄せる。
- 機能が複雑化した場合、同一機能ディレクトリ内で段階的に構造を分割する。

### 6.2.2 複雑化の判断基準（目安）
- 条件分岐や状態遷移ルールが増えている
- 同じ業務ルールが複数箇所に重複している
- 参照系と更新系の関心が明確に分離できる

## 6.3 Definition of Done（決定）
- DoDはタスク単位で判定する。
- 各タスクは親機能仕様書（`docs/specs/features/`）を参照必須とする。
- 完了には `spec + plan + tasks` の整合を必須とする。
- 検証は `lint + 関連unit + 必要e2e` を必須とする。
- ドキュメントのみ変更はテスト免除可（`lint`のみ）。
- 通常タスクはAIレビュー完了を必須とする。
- PR本文に実行コマンドと結果要約を必須とする。
- Hotfixでも事前AIレビューを必須とする。
- AIブロック指摘の例外マージは、理由とフォローアップ記録を条件に許可する。

### 6.3.1 DoD運用シナリオ
1. 通常実装タスク
- `spec + plan + tasks` が揃っている
- `lint + 関連unit (+ 必要e2e)` 実行済み
- AIレビュー完了
- PR証跡あり
- 上記を満たした時点で Done

2. ドキュメントのみタスク
- `lint` 実行済み
- AIレビュー完了
- PR証跡あり
- テスト未実施でも Done

3. Hotfixタスク
- 事前AIレビューを実施
- 未対応指摘がある場合は理由 + フォローアップをPRに記載
- `spec + plan + tasks` と変更理由を更新
- 上記を満たした時点で正式 Done

## 6.4 レビュー基準（決定）
### 6.4.1 目的
- 開発者1名体制において、AIレビューを品質ゲートとして運用する。

### 6.4.2 AIレビュー必須ルール
- すべてのPRでAIレビューを必須とする。
- マージ条件は「AIレビュー完了」とする。
- AIレビューはテスト実行後・PR前に1回実施する。
- AIレビュー証跡（所見要約 + 対応結果）をPR本文に必須記載する。

### 6.4.3 ブロック基準
- 仕様不一致
- バグリスク
- テスト不足

### 6.4.4 未対応指摘の扱い
- 未対応指摘が残る場合でも、理由をPR本文に記載すればマージ可とする。

### 6.4.5 例外マージ
- AIブロック指摘がある場合でも例外マージを許可する。
- 例外マージ時は、理由とフォローアップ（`tasks/` のIDまたは計画）を必須記載とする。

### 6.4.6 Hotfix運用
- Hotfixでも事前AIレビューを必須とする。
- 例外マージ時の記録ルール（理由 + フォローアップ）は通常PRと同じ。

## 6.5 ブランチ運用ルール（決定）
- 1ブランチ = 1タスクとする。
- ブランチ命名は `feature/<feature-name>-<task-name>` とする。
- `<feature-name>` と `<task-name>` はどちらも kebab-case とする。
- prefix は必須とし、機能実装タスクでは `feature/` を使用する。
- Gitの状態変更系コマンド（`checkout` / `switch` / `pull` / `merge` / `rebase`）は並列実行しない。
- Git操作は原則として逐次実行し、前コマンドの完了を確認してから次を実行する。

### 6.5.1 命名例
- `feature/auth-google-signin`
- `feature/store-update-seat-status`
- `feature/public-list-filter-by-genre`

## 6.6 仕様書テンプレート（決定）
- 機能仕様書のテンプレートは `docs/specs/features/_template.md` を使用する。
- 新規機能仕様書は上記テンプレートをベースに作成する。
- 仕様書では「何を満たすか」を定義し、実装手順・設計詳細は `plans/` で管理する。

## 6.7 リリース手順（決定）
### 6.7.1 環境区分
- `dev`: 日常の開発確認用
- `demo`: クライアント確認・中間成果物提出用（推奨）
- `prod`: 本番公開用

### 6.7.2 dev反映
- 目的: 開発中機能の動作確認
- 前提:
  - 対象タスクのDoDを満たしている
  - AIレビュー完了済み
- 実行:
  - `bun run deploy:dev`

### 6.7.3 demo反映（クライアント確認）
- 目的: 中間成果物の確認・合意形成
- 前提:
  - 対象機能の `spec + plan + tasks` が揃っている
  - 主要導線のE2E（必要な範囲）が通っている
  - デモ対象外の機能/未実装事項を明記している
- 提出物:
  - demo URL
  - 今回の確認ポイント
  - 既知の制約・未実装一覧
- 実行:
  - `bun run deploy:demo`

### 6.7.4 prod反映
- 目的: 本番公開
- 前提:
  - クライアント確認（demo）で合意済み
  - `prod` 向けSecrets/Bindingsが正しい
  - ロールバック手順を確認済み
- 実行:
  - `bun run deploy:prod`

### 6.7.5 ロールバック手順
1. 直前の安定版デプロイ情報を特定する
2. 問題原因を切り分けし、影響範囲を記録する
3. 安定版へ切り戻しデプロイを実施する
4. 切り戻し後のヘルスチェック（`/api/health`）を確認する
5. インシデント内容と再発防止タスクを `tasks/` に記録する

## 7. 更新履歴
- 2026-02-10: 初版作成（方針策定用の土台）
- 2026-02-10: テスト方針を追加（Unit: Vitest、E2E: Playwright、テスト配置ルール）
- 2026-02-10: ディレクトリ/設計方針を追加（Vertical Slice、段階的に DDD/CQRS を適用）
- 2026-02-10: Definition of Doneを追加（タスク単位判定、証跡/レビュー/例外運用を確定）
- 2026-02-10: レビュー基準を追加（1人開発 + AIレビュー必須運用を確定）
- 2026-02-10: ブランチ運用ルールを追加（1タスク1ブランチ、`feature/` + kebab-case）
- 2026-02-18: Git状態変更系コマンドの並列実行禁止を追記
- 2026-02-10: 機能仕様書テンプレートを確定（`docs/specs/features/_template.md`）
- 2026-02-10: リリース手順を確定（`dev / demo / prod` の3段階運用とロールバック）
- 2026-02-10: `demo` 環境実装を反映（`env.demo` と `deploy:demo` を追加）
- 2026-02-10: ドキュメント表記を確定版に統一（策定中/草案表現を解消）
